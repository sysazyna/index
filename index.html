<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>歴史マスター【全106項目・完全版】</title>
    <style>
        :root { --main: #2c3e50; --accent: #3498db; --correct: #27ae60; --wrong: #e74c3c; --check: #f1c40f; --bg: #f4f7f9; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; -webkit-tap-highlight-color: transparent; }
        .container { background: white; border-radius: 20px; padding: 20px; box-shadow: 0 4px 25px rgba(0,0,0,0.1); width: 100%; max-width: 500px; box-sizing: border-box; }
        .nav-row { display: flex; justify-content: space-between; margin-bottom: 10px; width: 100%; }
        .small-btn { padding: 8px 12px; font-size: 0.75rem; border: 1px solid #ccc; background: white; border-radius: 6px; color: #666; cursor: pointer; }
        .bar-bg { width: 100%; height: 8px; background: #e0e0e0; border-radius: 4px; overflow: hidden; margin: 5px 0 15px 0; }
        .bar-fill { height: 100%; background: var(--correct); width: 0%; transition: 0.4s; }
        .stats { display: flex; justify-content: space-between; font-size: 0.8rem; color: #7f8c8d; font-weight: bold; }
        h2 { font-size: 1.1rem; color: var(--main); margin: 10px 0; text-align: center; line-height: 1.4; }
        .menu-btn { width: 100%; margin: 7px 0; padding: 16px; border: 2px solid var(--accent); background: white; border-radius: 12px; font-weight: bold; color: var(--accent); font-size: 1rem; cursor: pointer; }
        .choice-btn { width: 100%; margin: 8px 0; padding: 16px; border: none; background: #f0f3f5; border-radius: 12px; font-weight: bold; text-align: left; cursor: pointer; }
        .order-item { background: #fff; border: 2px solid #dfe6e9; margin: 10px 0; padding: 16px; border-radius: 12px; font-weight: bold; position: relative; cursor: pointer; user-select: none; }
        .order-item.selected { border-color: var(--accent); background: #e3f2fd; color: var(--accent); }
        .num-circle { position: absolute; right: 15px; background: var(--accent); color: white; border-radius: 50%; width: 22px; height: 22px; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; }
        .res-card { display: none; margin-top: 20px; padding: 18px; border-radius: 12px; background: #fffde7; border: 1px solid #f9e79f; }
        .exp-txt { font-size: 0.9rem; color: #444; margin-top: 10px; line-height: 1.6; border-top: 1px solid #eee; padding-top: 10px; }
        .next-btn { width: 100%; padding: 16px; background: var(--main); color: white; border: none; border-radius: 12px; font-weight: bold; margin-top: 12px; cursor: pointer; }
        .copy-area { width: 100%; height: 80px; font-size: 0.75rem; margin-top: 10px; padding: 5px; }
    </style>
</head>
<body>

<div id="auth-screen" style="display:block; text-align:center; padding-top:50px;">
    <h2>合言葉を入力してください</h2>
    <input type="password" id="pass-input" style="padding:10px; font-size:1.2rem; width:150px; text-align:center; border-radius:8px; border:1px solid #ccc;">
    <button onclick="checkPass()" style="padding:10px 20px; background:var(--accent); color:white; border:none; border-radius:8px; margin-top:10px; cursor:pointer;">入室</button>
</div>

<div class="container" id="main-app" style="display:none;">
    <div id="nav-bar" class="nav-row" style="display:none;">
        <button class="small-btn" onclick="backToMenu()">最初に戻る</button>
        <button id="back-btn" class="small-btn" onclick="goBack()">前に戻る</button>
    </div>

    <div id="prog-ui" style="display:none;">
        <div class="stats">
            <span id="prog-txt">0 / 0 問</span>
            <span>正解: <span id="session-correct">0</span></span>
        </div>
        <div class="bar-bg"><div id="bar-fill" class="bar-fill"></div></div>
    </div>

    <div id="menu">
        <h2>歴史マスター【全106項目】</h2>
        <button class="menu-btn" onclick="startQuiz('meiji')">明治・幕末 (43問)</button>
        <button class="menu-btn" onclick="startQuiz('taisho')">大正・昭和前期 (27問)</button>
        <button class="menu-btn" onclick="startQuiz('showa2')">戦後・昭和後期 (21問)</button>
        <button class="menu-btn" onclick="startQuiz('heisei')">平成・現代 (15問)</button>
        <button class="menu-btn" style="background:var(--accent); color:white;" onclick="startQuiz('all')">全範囲モード (106問)</button>
        <button id="weak-btn" class="menu-btn" style="border-color:var(--wrong); color:var(--wrong); display:none;" onclick="startQuiz('weak')">苦手克服モード</button>
    </div>

    <div id="quiz" style="display:none;">
        <h2 id="q-txt"></h2>
        <div id="choices"></div>
        <div id="orders" style="display:none;"></div>
        <button id="decide-btn" class="next-btn" style="background:var(--accent); display:none;" onclick="evalOrder()">決定して判定</button>
        <div id="res-box" class="res-card">
            <div id="judge-txt" style="font-weight:bold; font-size:1.1rem;"></div>
            <div id="exp-txt" class="exp-txt"></div>
            <button class="next-btn" onclick="goNext()">次の問題へ</button>
        </div>
    </div>

    <div id="summary" style="display:none; text-align:center;">
        <h2 style="font-size:1.5rem;">全問終了！</h2>
        <div style="font-size:3rem; font-weight:bold; color:var(--accent);" id="final-pct">0%</div>
        <div style="background:#fdf2f2; padding:15px; border-radius:12px; margin-top:15px; text-align:left;">
            <strong style="color:var(--wrong);">⚠️ Gemini相談用テキスト</strong>
            <textarea id="gemini-text" class="copy-area" readonly></textarea>
            <button class="small-btn" style="width:100%; background:#5d6d7e; color:white; margin-top:5px; padding:10px;" onclick="copyGemini()">コピーしてGeminiへ</button>
        </div>
        <button class="next-btn" onclick="backToMenu()">メニューに戻る</button>
    </div>
</div>

<script>
const FAMILY_PASS = "2025";
function checkPass() {
    if(document.getElementById('pass-input').value === FAMILY_PASS) {
        document.getElementById('auth-screen').style.display = 'none';
        document.getElementById('main-app').style.display = 'block';
        updateStats();
    } else { alert("合言葉が違います"); }
}

const db = [
    // 明治・幕末 (1853-1911) - 106項目のための詳細データ
    {id:1, y:1853, e:"ペリー来航", c:"meiji", d:"浦賀に黒船が現れ、鎖国が終わるきっかけに。"},
    {id:2, y:1853, e:"クリミア戦争開始", c:"meiji", d:"ロシアとオスマン帝国などの戦争。近代戦の先駆け。"},
    {id:3, y:1854, e:"日米和親条約", c:"meiji", d:"下田・函館を開港し、米に補給を約束しました。"},
    {id:4, y:1856, e:"アロー戦争・パリ条約", c:"meiji", d:"第2次アヘン戦争と、クリミア戦争の講和条約。"},
    {id:5, y:1857, e:"インドの反乱", c:"meiji", d:"イギリスの支配に対し、インド兵（シパーヒー）が蜂起。"},
    {id:6, y:1858, e:"日米修好通商条約", c:"meiji", d:"不平等条約。領事裁判権を認め、関税自主権を失う。"},
    {id:7, y:1858, e:"アイグン条約・天津条約", c:"meiji", d:"ロシアや英仏が清と結んだ不平等条約です。"},
    {id:8, y:1859, e:"安政の大獄", c:"meiji", d:"井伊直弼が反対派（吉田松陰ら）を厳しく弾圧。"},
    {id:9, y:1860, e:"桜田門外の変", c:"meiji", d:"水戸浪士らが大老・井伊直弼を暗殺しました。"},
    {id:10, y:1860, e:"北京条約", c:"meiji", d:"アロー戦争後の講和。清の衰退が決定的。"},
    {id:11, y:1861, e:"南北戦争開始", c:"meiji", d:"アメリカ国内で奴隷制などをめぐり勃発した内戦。"},
    {id:12, y:1862, e:"生麦事件", c:"meiji", d:"薩摩藩主の行列を乱した英人が殺傷された事件。"},
    {id:13, y:1863, e:"薩英戦争・下関事件", c:"meiji", d:"薩摩・長州が外国の武力を知り、攘夷から倒幕へ。"},
    {id:14, y:1866, e:"薩長同盟", c:"meiji", d:"坂本龍馬の仲介で、薩摩と長州が倒幕で団結。"},
    {id:15, y:1867, e:"大政奉還・王政復古", c:"meiji", d:"江戸幕府が終了し、天皇中心の新政府が成立。"},
    {id:16, y:1868, e:"戊辰戦争・御誓文", c:"meiji", d:"旧幕府軍との戦いと、新政府の基本方針発表。"},
    {id:17, y:1869, e:"版籍奉還", c:"meiji", d:"土地（版）と人民（籍）を天皇に返還。"},
    {id:18, y:1869, e:"スエズ運河開通", c:"meiji", d:"地中海と紅海を結び、東西貿易が加速。"},
    {id:19, y:1870, e:"プロイセン・フランス戦争", c:"meiji", d:"ドイツ統一のきっかけとなった欧州の戦争。"},
    {id:20, y:1871, e:"廃藩置県・解放令", c:"meiji", d:"藩を廃止し中央集権化。身分差別も撤廃。"},
    {id:21, y:1871, e:"ドイツ帝国成立", c:"meiji", d:"ビスマルクのもとでドイツが統一されました。"},
    {id:22, y:1872, e:"学制・富岡製糸場", c:"meiji", d:"小学校教育と、官営模範工場が誕生。"},
    {id:23, y:1873, e:"徴兵令・地租改正", c:"meiji", d:"国民の兵役と、現金での安定した納税。"},
    {id:24, y:1874, e:"民撰議院設立建白書", c:"meiji", d:"国会開設を求め、自由民権運動が勃興。"},
    {id:25, y:1876, e:"日朝修好条規", c:"meiji", d:"日本が武力で朝鮮を開国。不平等条約。"},
    {id:26, y:1877, e:"西南戦争", c:"meiji", d:"西郷隆盛による士族最後の最大反乱。"},
    {id:27, y:1880, e:"国会期成同盟", c:"meiji", d:"国会開設を求める運動が全国規模に。"},
    {id:28, y:1881, e:"国会開設の勅諭", c:"meiji", d:"10年後の国会開設が約束されました。"},
    {id:29, y:1884, e:"秩父事件", c:"meiji", d:"不況の農民が民権運動の影響で蜂起。"},
    {id:30, y:1885, e:"内閣制度", c:"meiji", d:"初代総理大臣に伊藤博文が就任。"},
    {id:31, y:1886, e:"ノルマントン号事件", c:"meiji", d:"不平等条約（領事裁判権）への批判噴出。"},
    {id:32, y:1889, e:"帝国憲法発布", c:"meiji", d:"アジア初の近代憲法。天皇主権。"},
    {id:33, y:1890, e:"第1回帝国議会", c:"meiji", d:"日本で初めての国会が開会。"},
    {id:34, y:1894, e:"日清戦争・条約改正", c:"meiji", d:"清との戦い。同時に法権を回復。"},
    {id:35, y:1894, e:"甲午農民戦争", c:"meiji", d:"朝鮮で起きた農民反乱。日清戦争のきっかけ。"},
    {id:36, y:1895, e:"下関条約・三国干渉", c:"meiji", d:"勝利したが露・独・仏が返還を要求。"},
    {id:37, y:1900, e:"義和団事件", c:"meiji", d:"清の排外運動に連合軍が派遣。"},
    {id:38, y:1901, e:"八幡製鉄所", c:"meiji", d:"賠償金で建設。重工業発展の象徴。"},
    {id:39, y:1902, e:"日英同盟", c:"meiji", d:"ロシアに対抗し英と結んだ軍事同盟。"},
    {id:40, y:1904, e:"日露戦争開始", c:"meiji", d:"満州・韓国の権利をめぐる大戦争。"},
    {id:41, y:1905, e:"ポーツマス条約", c:"meiji", d:"日露戦争の講和。米の仲介。"},
    {id:42, y:1910, e:"韓国併合", c:"meiji", d:"韓国を日本の領土として支配。"},
    {id:43, y:1911, e:"関税自主権回復・辛亥革命", c:"meiji", d:"条約改正の完了と中国の革命。"},
    // 大正・昭和前期 (1914-1945)
    {id:44, y:1914, e:"第一次世界大戦開始", c:"taisho", d:"サラエボ事件を機に勃発。"},
    {id:45, y:1915, e:"二十一か条の要求", c:"taisho", d:"日本が中国に突きつけた利権要求。"},
    {id:46, y:1917, e:"ロシア革命", c:"taisho", d:"世界初の社会主義政権が誕生。"},
    {id:47, y:1918, e:"米騒動・原敬内閣", c:"taisho", d:"初の本格的政党内閣の成立。"},
    {id:48, y:1919, e:"ベルサイユ条約", c:"taisho", d:"第一次大戦の講和条約。"},
    {id:49, y:1919, e:"三・一、五・四運動", c:"taisho", d:"韓国・中国での民族独立運動。"},
    {id:50, y:1920, e:"国際連盟発足", c:"taisho", d:"世界平和のための国際組織。"},
    {id:51, y:1921, e:"ワシントン会議", c:"taisho", d:"海軍軍縮と太平洋の平和維持。"},
    {id:52, y:1922, e:"ソ連成立", c:"taisho", d:"社会主義共和国連邦が誕生。"},
    {id:53, y:1923, e:"関東大震災", c:"taisho", d:"首都圏を襲った巨大地震。"},
    {id:54, y:1925, e:"普通選挙法・治安維持法", c:"taisho", d:"選挙権拡大と弾圧のセット。"},
    {id:55, y:1929, e:"世界恐慌", c:"taisho", d:"米株価暴落から世界的な不況。"},
    {id:56, y:1931, e:"満州事変", c:"taisho", d:"柳条湖事件から関東軍が侵攻。"},
    {id:57, y:1932, e:"五・一五事件", c:"taisho", d:"犬養首相射殺。政党政治の崩壊。"},
    {id:58, y:1933, e:"国際連盟脱退", c:"taisho", d:"日本の国際的孤立が決定的。"},
    {id:59, y:1933, e:"ヒトラー政権誕生", c:"taisho", d:"ドイツでナチスが権力を掌握。"},
    {id:60, y:1936, e:"二・二六事件", c:"taisho", d:"陸軍の一部が起こしたクーデター。"},
    {id:61, y:1937, e:"日中戦争開始", c:"taisho", d:"盧溝橋事件。全面戦争へ。"},
    {id:62, y:1938, e:"国家総動員法", c:"taisho", d:"戦時の強制動員を可能に。"},
    {id:63, y:1939, e:"第二次世界大戦開始", c:"taisho", d:"独のポーランド侵攻で勃発。"},
    {id:64, y:1940, e:"日独伊三国同盟", c:"taisho", d:"枢軸国が連合国と対立。"},
    {id:65, y:1941, e:"太平洋戦争開始", c:"taisho", d:"真珠湾攻撃から対米英戦。"},
    {id:66, y:1941, e:"日ソ中立条約", c:"taisho", d:"日本とソ連が不戦を合意。"},
    {id:67, y:1945, e:"終戦・ポツダム宣言", c:"taisho", d:"8月15日、日本の敗戦。"},
    {id:68, y:1945, e:"ヤルタ会談・国連成立", c:"taisho", d:"戦後体制の決定と国連誕生。"},
    {id:69, y:1945, e:"広島・長崎に原爆", c:"taisho", d:"人類史上初の核兵器使用。"},
    {id:70, y:1930, e:"ロンドン軍縮会議", c:"taisho", d:"海軍の補助艦制限。統帥権干犯。"},
    // 昭和後期 (1946-1988)
    {id:71, y:1946, e:"日本国憲法公布", c:"showa2", d:"新しい民主主義のスタート。"},
    {id:72, y:1947, e:"日本国憲法施行", c:"showa2", d:"5月3日に正式に施行。"},
    {id:73, y:1949, e:"中華人民共和国成立", c:"showa2", d:"毛沢東による共産政権誕生。"},
    {id:74, y:1949, e:"NATO成立", c:"showa2", d:"西側の軍事同盟が誕生。"},
    {id:75, y:1950, e:"朝鮮戦争・特需景気", c:"showa2", d:"冷戦下の戦争。経済急回復。"},
    {id:76, y:1951, e:"サンフランシスコ平和条約", c:"showa2", d:"独立回復と日米安保締結。"},
    {id:77, y:1954, e:"自衛隊発足", c:"showa2", d:"防衛組織の確立。"},
    {id:78, y:1955, e:"アジア・アフリカ会議", c:"showa2", d:"第3勢力が平和を提唱。"},
    {id:79, y:1956, e:"日ソ共同宣言・国連加盟", c:"showa2", d:"国際社会への完全復帰。"},
    {id:80, y:1960, e:"日米新安保条約", c:"showa2", d:"激しい反対運動（安保闘争）。"},
    {id:81, y:1960, e:"アフリカの年", c:"showa2", d:"17カ国が一気に独立しました。"},
    {id:82, y:1962, e:"キューバ危機", c:"showa2", d:"核戦争寸前の米ソ対立。"},
    {id:83, y:1964, e:"東海道新幹線・東京五輪", c:"showa2", d:"高度成長の集大成。"},
    {id:84, y:1965, e:"日韓基本条約", c:"showa2", d:"韓国との国交正常化。"},
    {id:85, y:1965, e:"ベトナム戦争本格化", c:"showa2", d:"北爆により米が全面介入。"},
    {id:86, y:1972, e:"沖縄返還・日中共同声明", c:"showa2", d:"沖縄復帰と日中国交正常化。"},
    {id:87, y:1973, e:"石油危機", c:"showa2", d:"狂乱物価。高度成長の終焉。"},
    {id:88, y:1973, e:"ベトナム和平協定", c:"showa2", d:"米軍が撤退を開始しました。"},
    {id:89, y:1975, e:"第1回サミット", c:"showa2", d:"主要国首脳による経済会議。"},
    {id:90, y:1978, e:"日中平和友好条約", c:"showa2", d:"中国との友好を深める条約。"},
    {id:91, y:1955, e:"自由民主党結成(55年体制)", c:"showa2", d:"保革対立の政治体制が確立。"},
    // 平成・現代 (1989-2011)
    {id:92, y:1989, e:"消費税導入", c:"heisei", d:"平成開始と同時に3%開始。"},
    {id:93, y:1989, e:"ベルリンの壁崩壊", c:"heisei", d:"冷戦の終わりを象徴。"},
    {id:94, y:1989, e:"天安門事件", c:"heisei", d:"中国で民主化を求める学生を武力鎮圧。"},
    {id:95, y:1990, e:"ドイツ統一", c:"heisei", d:"東西ドイツが一つに。"},
    {id:96, y:1991, e:"バブル崩壊・ソ連解体", c:"heisei", d:"激動の世界と国内不況。"},
    {id:97, y:1991, e:"湾岸戦争", c:"heisei", d:"イラクのクウェート侵攻に対し多国籍軍。"},
    {id:98, y:1992, e:"PKO協力法", c:"heisei", d:"自衛隊の海外派遣が可能に。"},
    {id:99, y:1993, e:"EU成立", c:"heisei", d:"欧州連合が誕生しました。"},
    {id:100, y:1995, e:"阪神・淡路大震災", c:"heisei", d:"1月に起きた巨大震災。"},
    {id:101, y:1997, e:"京都会議(COP3)", c:"heisei", d:"温室効果ガスの削減合意。"},
    {id:102, y:1998, e:"長野オリンピック", c:"heisei", d:"冬季五輪。国内インフラ整備。"},
    {id:103, y:2001, e:"アメリカ同時テロ", c:"heisei", d:"9.11。世界が衝撃。"},
    {id:104, y:2002, e:"日朝平壌宣言", c:"heisei", d:"小泉首相が初訪朝。"},
    {id:105, y:2003, e:"自衛隊イラク派遣", c:"heisei", d:"イラク復興支援のための派遣。"},
    {id:106, y:2011, e:"東日本大震災", c:"heisei", d:"3.11。未曾有の複合災害。"}
];

let wrongs = new Set(JSON.parse(localStorage.getItem('wr_final_v6') || '[]'));
let pool = [], currentQ = null, currentIndex = 0, sessionScore = 0, sessionWrongs = [];
let userOrder = [];

function updateStats() {
    document.getElementById('weak-btn').style.display = (wrongs.size > 0) ? 'block' : 'none';
}

function startQuiz(mode) {
    if(mode === 'weak') {
        pool = db.filter(i => wrongs.has(i.e));
    } else {
        pool = mode === 'all' ? [...db] : db.filter(i => i.c === mode);
    }
    pool.sort(() => Math.random() - 0.5);
    currentIndex = 0; sessionScore = 0; sessionWrongs = [];
    document.getElementById('menu').style.display = 'none';
    document.getElementById('nav-bar').style.display = 'flex';
    document.getElementById('prog-ui').style.display = 'block';
    document.getElementById('summary').style.display = 'none';
    document.getElementById('quiz').style.display = 'block';
    next();
}

function next() {
    if(currentIndex >= pool.length) return showSummary();
    document.getElementById('res-box').style.display = 'none';
    document.getElementById('decide-btn').style.display = 'none';
    document.getElementById('back-btn').disabled = (currentIndex === 0);
    document.getElementById('prog-txt').innerText = `${currentIndex + 1} / ${pool.length} 問目`;
    document.getElementById('bar-fill').style.width = `${((currentIndex+1)/pool.length)*100}%`;
    document.getElementById('session-correct').innerText = sessionScore;

    if(currentIndex % 3 === 2 && (pool.length - currentIndex) >= 3) {
        setupOrder();
    } else {
        setupYear();
    }
}

function setupYear() {
    currentQ = { ...pool[currentIndex], type:'year' };
    document.getElementById('q-txt').innerText = `「${currentQ.e}」は何年？`;
    document.getElementById('orders').style.display = 'none';
    const area = document.getElementById('choices');
    area.style.display = 'block'; area.innerHTML = '';
    
    let opts = [currentQ.y];
    while(opts.length < 4) {
        let r = db[Math.floor(Math.random()*db.length)].y;
        if(!opts.includes(r)) opts.push(r);
    }
    opts.sort(() => Math.random() - 0.5);
    opts.forEach(y => {
        const b = document.createElement('button');
        b.className = 'choice-btn'; b.innerText = `${y}年`;
        b.onclick = () => finish(y === currentQ.y, `正解：${currentQ.y}年`);
        area.appendChild(b);
    });
}

function setupOrder() {
    let subItems = pool.slice(currentIndex, currentIndex + 3);
    currentQ = { correct: [...subItems].sort((a,b) => a.y - b.y), type:'order', items: subItems };
    document.getElementById('q-txt').innerText = "古い順に3つ選んでください\n(再タップで解除)";
    document.getElementById('choices').style.display = 'none';
    const area = document.getElementById('orders');
    area.style.display = 'block'; 
    userOrder = [];
    renderOrderItems();
}

function renderOrderItems() {
    const area = document.getElementById('orders');
    area.innerHTML = '';
    currentQ.items.forEach(item => {
        const d = document.createElement('div');
        d.className = 'order-item';
        const selIdx = userOrder.findIndex(i => i.id === item.id);
        if(selIdx !== -1) {
            d.classList.add('selected');
            d.innerHTML = `<span class="num-circle">${selIdx + 1}</span>${item.e}`;
        } else {
            d.innerText = item.e;
        }
        d.onclick = () => {
            const existingIdx = userOrder.findIndex(i => i.id === item.id);
            if(existingIdx !== -1) { userOrder.splice(existingIdx, 1); }
            else { if(userOrder.length < 3) userOrder.push(item); }
            renderOrderItems();
        };
        area.appendChild(d);
    });
    document.getElementById('decide-btn').style.display = (userOrder.length === 3) ? 'block' : 'none';
}

function evalOrder() {
    const ok = userOrder.every((v, i) => v.id === currentQ.correct[i].id);
    const msg = "【正しい順序】<br>" + currentQ.correct.map((i,idx) => `${idx+1}. ${i.y}年: ${i.e}`).join('<br>');
    finish(ok, msg);
}

function finish(ok, title) {
    document.getElementById('res-box').style.display = 'block';
    const j = document.getElementById('judge-txt');
    if(ok) {
        j.innerText = "⭕ 正解！"; j.style.color = "var(--correct)";
        sessionScore++;
        if(currentQ.type === 'year') wrongs.delete(currentQ.e);
        else currentQ.items.forEach(it => wrongs.delete(it.e));
    } else {
        j.innerText = "❌ 不正解"; j.style.color = "var(--wrong)";
        if(currentQ.type === 'year') {
            wrongs.add(currentQ.e);
            sessionWrongs.push(currentQ);
        } else {
            currentQ.items.forEach(it => wrongs.add(it.e));
            sessionWrongs.push(currentQ.correct[0]); 
        }
    }
    const exp = (currentQ.type === 'year') ? currentQ.d : "順番を整理しましょう。";
    document.getElementById('exp-txt').innerHTML = `<strong>${title}</strong><br><br>${exp}`;
    save();
}

function goNext() { currentIndex++; next(); }
function goBack() { if(currentIndex > 0) { currentIndex--; next(); } }

function backToMenu() {
    document.getElementById('quiz').style.display = 'none';
    document.getElementById('prog-ui').style.display = 'none';
    document.getElementById('nav-bar').style.display = 'none';
    document.getElementById('summary').style.display = 'none';
    document.getElementById('menu').style.display = 'block';
    updateStats();
}

function showSummary() {
    document.getElementById('quiz').style.display = 'none';
    document.getElementById('prog-ui').style.display = 'none';
    document.getElementById('summary').style.display = 'block';
    const pct = Math.round((sessionScore / pool.length) * 100);
    document.getElementById('final-pct').innerText = `${pct}%`;
    let gem = "【歴史学習分析】以下の問題で間違えました。解説をお願いします。\n\n" + sessionWrongs.map(w => `・${w.y}年：${w.e}`).join("\n");
    document.getElementById('gemini-text').value = gem;
}

function copyGemini() { document.getElementById('gemini-text').select(); document.execCommand('copy'); alert("コピーしました！"); }
function save() { localStorage.setItem('wr_final_v6', JSON.stringify(Array.from(wrongs))); }
updateStats();
</script>
</body>
</html>